# Pytest シナリオフィルタ改修設計（複数タグ OR）

## 背景と目的
- 現状 `--tag <string>` で 1 タグのみフィルタ可能。
- 複数タグを OR 条件（例: `tag1` または `tag2` を含むシナリオを実行）で指定したい。
- pytest 側のインターフェースは最小変更にし、既存利用（単一タグ指定）がそのまま動くことを担保する。

## 現状
- `tests/conftest.py`  
  - `pytest_addoption` で `--tag` を単一文字列として受け取る。
  - `pytest_generate_tests` で `ScenarioLoader.load_scenarios(tag_filter=tag if tag else None)` を呼ぶ。
- `src/core/scenario_loader.py`  
  - `load_scenarios(tag_filter: str = None)` が単一タグ一致でフィルタする。
- シナリオの `tags` は文字列配列で、完全一致のみを想定。

## スコープ
- 追加仕様: `--tag "tag1,tag2"` のようにカンマ区切りで複数指定した場合、OR 条件でフィルタする。空白はトリム。
- 非スコープ: AND 条件、正規表現、除外タグ、タグの大文字小文字無視の変更。

## 仕様案
1) CLI 仕様  
   - 既存の `--tag <string>` オプションを流用。値をカンマ区切りで複数指定可能にする。  
   - 例: `--tag "tag1,tag2"` → `tag1` または `tag2` を含むシナリオを残す。
   - 単一タグ指定は従来どおり。

2) パースとバリデーション  
   - `tests/conftest.py` 側で受け取った文字列をそのまま `ScenarioLoader` に渡す（後段でパース）。  
   - `ScenarioLoader` でカンマ分割し、空白をトリム。空要素は無視。  
   - すべて空の場合はフィルタなし扱い。

3) フィルタロジック（OR 条件）  
   - `scenario["tags"]` に `tag_filters` のいずれかが含まれていれば採用。  
   - 大文字小文字は現行踏襲（区別する）。  
   - `tags` が欠落または配列でない場合はスキップ（現行どおり）。

4) テスト観点  
   - 単一タグで従来どおり動くこと。  
   - `--tag "tag1,tag2"` で両タグのシナリオが実行対象に含まれること。  
   - 前後空白を含む入力（`" tag1 , tag2 "`）でも正しくトリムされること。  
   - `--tag ","` のような空要素のみの場合はフィルタなしになること。  
   - `tags` 未設定シナリオはフィルタ指定時に除外されることを確認。  
   - 文字種の大文字小文字が現行と変わらない（区別する）こと。

5) 影響範囲  
   - CLI は追加引数なし（互換）。  
   - `ScenarioLoader` のフィルタ処理のみ変更予定。  
   - 既存のレポート・コンテキスト出力に影響なし。

## 実装ステップ（想定）
1. `ScenarioLoader.load_scenarios` にカンマ区切りの分割処理と OR 判定を追加。  
2. `conftest.py` は現行のまま（`--tag` を文字列で受け渡し）。  
3. ドキュメント更新（pytest サンプルに複数タグ指定の例を追記）。  
4. 簡易ユニットテストまたは結合テスト（`pytest -k` で対象 ID を確認できるよう、ダミーの JSON シナリオに複数タグを付与して検証）。  
5. 任意: AND 条件が必要になる場合の拡張方針を別途検討（`--tag-all "a,b"` などの新オプション）。

## リスクと留意点
- カンマをタグ名として使っているケースは非対応（従来も想定外）。  
- トリムの挙動が変わるため、先頭/末尾に空白を含むタグ名がもし存在する場合は一致しなくなる（通常は問題にならない想定）。
