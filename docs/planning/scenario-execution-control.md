# シナリオ実行制御の拡張要件定義

## 背景と課題
現在のテストフレームワークでは、`pytest tests/test_runner.py` を実行すると、`scenarios` フォルダ以下の全ての JSON ファイルが再帰的にスキャンされ、実行対象となります。
フィルタリング機能として `--tag` や pytest 標準の `-k` (IDマッチ) が存在しますが、以下のユースケースに対応できていません。

1. **特定フォルダのみの実行**: 特定の業務領域（サブフォルダ）だけをテストしたい場合でも全件スキャンが走り、実行開始まで時間がかかる。また、意図しないフォルダのテストが混入するリスクがある。
2. **実行順序の制御**: 業務フローとして「登録」→「承認」のように順序依存があるシナリオを実行したい場合、現状はタグやファイル名でのソート順（OS依存により不定な場合あり）に頼らざるを得ない。

## 要件詳細

### 1. 特定フォルダ下のシナリオ実行
- **概要**: 実行時にディレクトリパスを指定し、そのディレクトリ配下のシナリオのみをロード・実行対象とする機能。
- **インターフェース案**: 
    - コマンドライン引数 `--dir` の追加。
    - 例: `pytest tests/test_runner.py --dir scenarios/order_management`
- **挙動**:
    - 指定されたパスが `scenarios` ディレクトリからの相対パス、または絶対パスとして解決できる場合、そのフォルダを起点に再帰探索を行う。
    - 指定がない場合は従来通り `scenarios` ルートから探索する。

### 2. 指定順序でのシナリオ実行
- **概要**: 実行したいシナリオIDをリストで指定し、その指定順通りにテストを実行する機能。
- **インターフェース案**:
    - コマンドライン引数 `--ids` の追加。
    - 例: `pytest tests/test_runner.py --ids "LOGIN-01,ORDER-01,APPROVE-01"`
- **挙動**:
    - 指定されたIDリストに含まれるシナリオのみを抽出する（フィルタリング）。
    - 抽出されたシナリオを、リストで指定された順序に並び替える（ソート）。
    - `-k` オプションとの併用時は `--ids` が優先される、あるいは競合エラーとする。
    - `--tag` オプションとの併用も可能とする（タグで絞り込んだ上で、IDリストにあるものだけ順序通りなど、あるいはIDリスト指定時はタグ無視など要検討。IDリスト指定が最も具体的であるため、ID指定を優先する仕様が望ましい）。

## 実装への影響
### `ScenarioLoader` の改修
- `__init__` または `load_scenarios` メソッドで、検索ルートパスを動的に変更できるようにする。
- `load_scenarios` メソッド内で、IDリストを受け取り、フィルタリングと並び替えを行うロジックを追加する。

### `conftest.py` の改修
- `pytest_addoption` に `--dir` と `--ids` を追加する。
- `pytest_generate_tests` 内でオプション値を取得し、`ScenarioLoader` に渡す。

## 制約事項
- `pytest-xdist` などによる並列実行を行う場合、順序指定は無視される可能性がある（worker間での分配順序になるため）。本フレームワークでの並列実行サポート状況に依存するが、順序依存テストは並列実行すべきではないため、順序指定時は直列実行を前提とする。
